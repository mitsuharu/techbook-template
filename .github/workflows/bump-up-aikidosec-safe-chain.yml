# aikidosec-safe-chain.yml で定義した AikidoSec/safe-chain のバージョンを定期的に更新する
name: Bump up AikidoSec/safe-chain version

on:
  schedule:
    # 毎月1日 03:00 UTC（日本時間だと12:00）
    - cron: "0 3 1 * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  workflows: write

jobs:
  bump:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Detect latest safe-chain release and update file
        id: bump
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          OWNER: AikidoSec
          REPO: safe-chain
          TARGET_FILE: .github/workflows/aikidosec-safe-chain.yml
        with:
          script: |
            const fs = require("fs");

            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const targetFile = process.env.TARGET_FILE;

            // 1) 現在のバージョンを YAML から取得
            const original = fs.readFileSync(targetFile, "utf8");
            const m = original.match(/export\s+SAFE_CHAIN_VERSION=([0-9]+(?:\.[0-9]+){2})/);
            if (!m) {
              core.setFailed(`SAFE_CHAIN_VERSION not found in ${targetFile}`);
              return;
            }
            const current = m[1];

            // 2) GitHub Releases の最新を取得
            //    GET /repos/{owner}/{repo}/releases/latest
            const latestRel = await github.rest.repos.getLatestRelease({ owner, repo });
            const tag = latestRel.data.tag_name || "";
            const latest = tag.replace(/^v/, "");

            core.info(`Current: ${current}`);
            core.info(`Latest tag: ${tag} -> ${latest}`);

            if (!latest || !/^[0-9]+(\.[0-9]+){2}$/.test(latest)) {
              core.setFailed(`Unexpected latest version format: ${tag}`);
              return;
            }

            if (latest === current) {
              core.setOutput("changed", "false");
              core.info("Already up to date.");
              return;
            }

            // 3) ファイルを書き換え
            const updated = original.replace(
              /export\s+SAFE_CHAIN_VERSION=[0-9]+(?:\.[0-9]+){2}/,
              `export SAFE_CHAIN_VERSION=${latest}`
            );

            fs.writeFileSync(targetFile, updated, "utf8");

            core.setOutput("changed", "true");
            core.setOutput("current", current);
            core.setOutput("latest", latest);

      - name: Create PR
        if: steps.bump.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: chore/bump-up-aikidosec-safe-chain-${{ steps.bump.outputs.latest }}
          title: "chore: bump up AikidoSec/safe-chain to ${{ steps.bump.outputs.latest }}"
          commit-message: "chore: bump up AikidoSec/safe-chain to ${{ steps.bump.outputs.latest }}"
          body: |
            This PR bumps AikidoSec/safe-chain from `${{ steps.bump.outputs.current }}` to `${{ steps.bump.outputs.latest }}`.

            - Automated monthly check (GitHub Actions).
